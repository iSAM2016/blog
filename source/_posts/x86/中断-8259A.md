---
title: 真象还原-中断-8259A
date: 2022-01-09 18:03:57
tags:
categories:
- 操作系统
---
> 建议: 本章节细节内容过多，而且还有c语言编程，对新手挑战很大，大家可以值了解理论，将作者写的代码 当做工具类进行处理，直接调用
 
可屏蔽中断的代理—可编程中断控制器 8259A。

8259A的作用是负责所有外来设备的中断，其中就包括来自时钟的中断，以后我们要通过它完成进程调度。

 # 8259A 介绍

为了让 CPU 获得每个外部设备的中断信号，最好的方式是在 CPU 中为每一个外设准备一个引脚接收中断，但这是不可能的.

可屏蔽中断是通过 INTR 信号线进入 CPU 的，一般可独立运行的外部设备，如打印机、声卡等，其发出的中断都是可屏蔽中断，都共享这一根 INTR 信号线通知 CPU。

中断代理，由它负责对所有中断仲裁，决定哪个中断优先被 CPU 受理。

8259A 用于管理和控制可屏蔽中断，它表现在屏蔽外设中断，对它们实行优先级判决，向 CPU 提供中断向量号等功能。

8259A 只可以管理 8 个中断， 将多个 8259A 组合，官方术语就是级联,这样就可以处理多个中断。 级联时只能有一片 8259A 为主片 master，其余的均为从片 slave。来自从片的中断只能传递给主片，再由主片向上传递给 CPU，也就是说只有主片才会向 CPU 发送 INT 中断信号。

每个独立运行的外部设备都是一个中断源，它们所发出的中断，只有接在中断请求（IRQ：Interrupt ReQuest）信号线上才能被 CPU 知晓.


# 级联
由于单个 8259A 芯片只有 8 个中断请求信号线：IRQ0～IRQ7，这显然是不够用的，所以它提供了一种组合的方式，可以将多个自己像串联电路一样组合在一起，提供更多的中断请求信号线。这种组合方式就称为级联（cascade） 

咱们平时用的交换机或 hub 都是这样做的，一个交换机上的网线接口是有限的，当上网的人多了接口不够用的时候，只能再买个交换机插在老交换机上做扩展，这就是典型的级联。


外部设备和 8259A 芯片是独立的，它们也得通过信号线连接到 8259A，主板电路上已经实现了这些，咱们只要把外设往主板上一插，这些设备自动就和 8259A 连接上了。

这些设备在发中断的时候都以为是直接发给了CPU，它们并不知道中间还隔着个中断代理，8259A 在收到了中断后，对中断判优，将优先级最高的中断转发给 CPU 处理。

![](https://isam2016hexo.oss-cn-hangzhou.aliyuncs.com/img/20220111140606.jpg)


![](https://isam2016hexo.oss-cn-hangzhou.aliyuncs.com/img/20220111135426.jpg)

## 8259A工作流程

![](https://isam2016hexo.oss-cn-hangzhou.aliyuncs.com/img/20220111141435.jpg)

8259A中一些寄存器的介绍：

* INT：8259A 选出优先级最高的中断请求后，发信号通知 CPU。
* INTA：INT Acknowledge，中断响应信号。位于 8259A 中的 INTA 接收来自 CPU 的 INTA 接口的中断响应信号。
* IMR：Interrupt Mask Register，中断屏蔽寄存器，宽度是 8 位，用来屏蔽某个外设的中断。 
* IRR：Interrupt Request Register，中断请求寄存器，宽度是8 位。它的作用是接受经过IMR 寄存器过滤后的中断信号并锁存，此寄存器中全是等待处理的中断， “相当于”5259A 维护的未处理中断信号队列。
* PR：Priority Resolver，优先级仲裁器。当有多个中断同时发生，或当有新的中断请求进来时，将它与当前正在处理的中断进行比较，找出优先级更高的中断
* ISR： In-Service Register， 中断服务寄存器， 宽度是8 位。 当某个中断正在被处理时， 保存在此寄存器

接收中断后的流程图：

文字部分没有摘抄

![](https://isam2016hexo.oss-cn-hangzhou.aliyuncs.com/img/20220111163945.jpg)

由于大部分情况下 8259A 的起始中断向量号并不是 0（起始中断向量号被修改，原因后面会说） ，所以用起始中断向量号+IRQ 接口号便是该设备的中断向量号，由此可见，外部设备虽然会发中断信号，但它并不知道还有中断向量号这回事，不知道自己会被中断代理（如 8259A）分配一个这样的整数。



 并不是进入了 ISR 后的中断就进入 CPU 了，它还是有可能被后者换下来的。
 
 比如， 在 8259A 发送中断向量号给 CPU 之前， 这时候又来了新的中断， 如果它的来源 IRQ 接口号比 ISR 中的低， 也就是优先级更高， 原来 ISR 中准备上 CPU 处理的旧中断， 其对应的 BIT 就得清 0， 同时将它所在的 IRR 中的相应 BIT 恢复为 1，随后在 ISR 中将此优先级更高的新中断对应的 BIT 置 1，然后将此新中断的中断向量号发给 CPU。

 # 中断处理框架的流程

 CPU 也提供了中断处理的框架。在此框架中，咱们只要填入所需要的数据即可，其他的工作由 CPU 自动运作。和中断处理相关的数据结构是中断描述符表和中断向量号，我们要做的工作就是准备这两项。
 
以上说的是中断处理框架的流程，我们要做的
* 构造好 IDT（中断描述符表）。
* 提供中断向量号。
<!-- 
# 8259A的编程
TODO: 没有学好
8259A的编程主要有三个部分：

1. 设置主片与从片的级联方式
2. 指定起始中断向量号
3. 设置各种工作模式

中断向量号是逻辑上的东西，它在物理上是 8259A 上的 IRQ 接口号。8259A 上 IRQ 号的排列顺序是固定的，但其对应的中断向量号是不固定的，这其实是一种由硬件到软件的映射，通过设置 8259A，可以将 IRQ 接口映射到不同的中断向量号。

在 8259A 内部有两组寄存器:
* 初始化命令寄存器组，用来保存初始化命令字 ICW共4个。ICW1-ICW4
* 操作命令寄存器组，用来保存操作命令字OCW 共3个

我们对 8259A 的编程，也分为初始化和操作两部分:

* 一部分是用 ICW 做初始化，用来确定是否需要级联，设置起始中断向量号，设置中断结束模式。Ț

其编程就是往 8259A 的端口发送一系列 ICW。由于从一开始就要决定 8259A 的工作状态，所以要一次性写入很多设置，某些设置之间是具有关联、依赖性的，也许后面的某个设置会依赖前面某个 ICW 写入的设置， 所以这部分要求严格的顺序，必须依次写入 ICW1、ICW2、ICW3、ICW4。 

* 另一部分是用 OCW 来操作控制 8259A，前面所说的中断屏蔽和中断结束，就是通过往 8259A 端口发送 OCW 实现的。OCW 的发送顺序不固定，3 个之中先发送哪个都可以。

## ICW1

ICW1 用来初始化 8259A 的连接方式和中断信号的触发方式。连接方式是指用单片工作，还是用多片级联工作，触发方式是指中断请求信号是电平触发，还是边沿触发。ICW1 需要写入到主片的 0x20 端口和从片的 0xA0 端口.

![](https://isam2016hexo.oss-cn-hangzhou.aliyuncs.com/img/20220112140327.jpg)

* IC4 表示是否要写入 ICW4，x86 系统 IC4 必须为 1。
* SNGL 表示 single，若 SNGL 为 1，表示单片，若 SNGL 为 0，表示级联（cascade）
* ADI 表示 call address interval，用来设置 8085 的调用时间间隔，x86 不需要设置。
* LTIM 表示 level/edge triggered mode，用来设置中断检测方式，LTIM 为 0 表示边沿触发，LTIM 为 1 表示电平触发。
* 第 4 位的 1 是固定的，这是 ICW1 的标记，此时您可能不明白标记是什么，不过在本节的最后您将茅塞顿开。
* 第 5～7 位专用于 8085 处理器，x86 不需要，直接置为 0 即可。

## ICW2
ICW2 用来设置起始中断向量号，就是前面所说的硬件 IRQ 接口到逻辑中断向量号的映射。由于每个8259A 芯片上的 IRQ 接口是顺序排列的，所以咱们这里的设置就是指定 IRQ0 映射到的中断向量号，其他IRQ 接口对应的中断向量号会顺着自动排下去。

注意，ICW2 需要写入到主片的 0x21 端口和从片的 0xA1 端口如图 7-14 所示。
![](https://isam2016hexo.oss-cn-hangzhou.aliyuncs.com/img/20220112152033.jpg) -->