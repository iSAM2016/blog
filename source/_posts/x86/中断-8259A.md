---
title: 真象还原-中断-8259A
date: 2022-01-09 18:03:57
tags:
categories:
- 操作系统
---
 
 可屏蔽中断的代理—可编程中断控制器 8259A。

 8259A的作用是负责所有外来设备的中断，其中就包括来自时钟的中断，以后我们要通过它完成进程调度。

 # 8259A 介绍

为了让 CPU 获得每个外部设备的中断信号，最好的方式是在 CPU 中为每一个外设准备一个引脚接收中断，但这是不可能的.

可屏蔽中断是通过 INTR 信号线进入 CPU 的，一般可独立运行的外部设备，如打印机、声卡等，其发出的中断都是可屏蔽中断，都共享这一根 INTR 信号线通知 CPU。

中断代理，由它负责对所有中断仲裁，决定哪个中断优先被 CPU 受理。

8259A 用于管理和控制可屏蔽中断，它表现在屏蔽外设中断，对它们实行优先级判决，向 CPU 提供中断向量号等功能。

8259A 只可以管理 8 个中断， 将多个 8259A 组合，官方术语就是级联,这样就可以处理多个中断。 级联时只能有一片 8259A 为主片 master，其余的均为从片 slave。来自从片的中断只能传递给主片，再由主片向上传递给 CPU，也就是说只有主片才会向 CPU 发送 INT 中断信号。

每个独立运行的外部设备都是一个中断源，它们所发出的中断，只有接在中断请求（IRQ：Interrupt ReQuest）信号线上才能被 CPU 知晓.


# 级联
由于单个 8259A 芯片只有 8 个中断请求信号线：IRQ0～IRQ7，这显然是不够用的，所以它提供了一种组合的方式，可以将多个自己像串联电路一样组合在一起，提供更多的中断请求信号线。这种组合方式就称为级联（cascade） 

咱们平时用的交换机或 hub 都是这样做的，一个交换机上的网线接口是有限的，当上网的人多了接口不够用的时候，只能再买个交换机插在老交换机上做扩展，这就是典型的级联。


外部设备和 8259A 芯片是独立的，它们也得通过信号线连接到 8259A，主板电路上已经实现了这些，咱们只要把外设往主板上一插，这些设备自动就和 8259A 连接上了。

这些设备在发中断的时候都以为是直接发给了CPU，它们并不知道中间还隔着个中断代理，8259A 在收到了中断后，对中断判优，将优先级最高的中断转发给 CPU 处理。

![](20220111140606.jpg)


![](20220111135426.jpg)

## 8259A工作流程

![](20220111141435.jpg)

8259A中一些寄存器的介绍：

* INT：8259A 选出优先级最高的中断请求后，发信号通知 CPU。
* INTA：INT Acknowledge，中断响应信号。位于 8259A 中的 INTA 接收来自 CPU 的 INTA 接口的中断响应信号。
* IMR：Interrupt Mask Register，中断屏蔽寄存器，宽度是 8 位，用来屏蔽某个外设的中断。 
* IRR：Interrupt Request Register，中断请求寄存器，宽度是8 位。它的作用是接受经过IMR 寄存器过滤后的中断信号并锁存，此寄存器中全是等待处理的中断， “相当于”5259A 维护的未处理中断信号队列。
* PR：Priority Resolver，优先级仲裁器。当有多个中断同时发生，或当有新的中断请求进来时，将它与当前正在处理的中断进行比较，找出优先级更高的中断
* ISR： In-Service Register， 中断服务寄存器， 宽度是8 位。 当某个中断正在被处理时， 保存在此寄存器

接收中断后的流程图：

文字部分没有摘抄

![](20220111163945.jpg)

由于大部分情况下 8259A 的起始中断向量号并不是 0（起始中断向量号被修改，原因后面会说） ，所以用起始中断向量号+IRQ 接口号便是该设备的中断向量号，由此可见，外部设备虽然会发中断信号，但它并不知道还有中断向量号这回事，不知道自己会被中断代理（如 8259A）分配一个这样的整数。



 并不是进入了 ISR 后的中断就进入 CPU 了，它还是有可能被后者换下来的。
 
 比如， 在 8259A 发送中断向量号给 CPU 之前， 这时候又来了新的中断， 如果它的来源 IRQ 接口号比 ISR 中的低， 也就是优先级更高， 原来 ISR 中准备上 CPU 处理的旧中断， 其对应的 BIT 就得清 0， 同时将它所在的 IRR 中的相应 BIT 恢复为 1，随后在 ISR 中将此优先级更高的新中断对应的 BIT 置 1，然后将此新中断的中断向量号发给 CPU。

 # 中断处理框架的流程

 CPU 也提供了中断处理的框架。在此框架中，咱们只要填入所需要的数据即可，其他的工作由 CPU 自动运作。和中断处理相关的数据结构是中断描述符表和中断向量号，我们要做的工作就是准备这两项。
 
以上说的是中断处理框架的流程，我们要做的
* 构造好 IDT（中断描述符表）。
* 提供中断向量号。

