
如二区wTYU78574--
title: 真象还原-中断
date: 2021-11-19 10:14:40
tags:
categories:
- 操作系统
---
由于 CPU 获知了计算机中发生的某些事，CPU 暂停正在执行的程序，转而去执行处理该事件的程序， 当这段程序执行完毕后，CPU 继续执行刚才的程序。整个过程称为中断处理，也称为中断。

操作系统是中断驱动的。

操作系统是个死循环，保证操作系统能保证操作系统周而复始的运行下去，而运行的目的是为了等候某些事情发生

# 中断的分类
* 来自 CPU 外部的中断就称为外部中断（是否导致宕机来划分）
    * 可屏蔽中断 
    * 不可屏蔽中断
* 来自 CPU 内部的中断称为内部中断（否正常来划分）
  * 软中断
  * 异常

外部硬件的中断是通过两根信号线通知 CPU 的， 这两根信号线就是INTR和 NMI,我们在汇编的时候了解过。
![](20211119180823.jpg)

所有的外部设备的中断信息都走一根信号线。

* 只要从 INTR 引脚收到的中断都是不影响系统运行的，可以随时处理，甚至 CPU 可以不处理，它不影响 CPU 运行。
* 只要从 NMI 引脚收到的中断，会影响cpu运行。

## 可屏蔽中断
可屏蔽的意思是此外部设备发出的中断，CPU 可以不理会，因为它不会让系统宕机，所以可以通过 eflags 寄存器的 IF 位将所有这些外部设备的中断屏蔽。

Linux把中断分为上半部和下半部分开处理。

操作系统是中断驱动的，中断发生后会执行相应的中断处理程序，中断处理程序中需要立即执行的部分在上半部，完成中断应答或硬件复位等重要紧迫工作。中断处理程序中不紧急的部分则被推迟到下半部中去完成。上半部是在关中断的情况下执行，不可被打扰，下半部则不是。

中断发起时，相应的中断向量号通过 NMI 或 INTR 引脚被传入 CPU，中断向量号是中断向量表或中断描述符表里中断项的下标，CPU 根据此中断向量号在中断向量表或中断描述符表中检索对应的中断处理程序并去执行。

## 不可屏蔽中断
不可屏蔽中断是通过 NMI 引脚进入 CPU 的，它表示系统中发生了致命的错误，它等同于宣布：计算机的运行到此结束了。

# 内部中断
软中断，就是由软件主动发起的中断，因为它来自于软件，所以称之为软中断。由于该中断是软件运行中主动发起的，所以它是主观上的，并不是客观上的某种内部错误。

中断的指令
* `int 8位立即数` : 系统调用
* `int3`: 调试断点指令
* `into`: 中断溢出指令
* `bound`: 这是检查数组索引越界指令

除第一种的 “int 8 位立即数” 之外， 其他的几种又可以称为异常。ˢ因为它们既具备软中断的“主动”行为，又具备异常的“错误”结果。

异常分为三种：
* fault 故障 可以被修复，属于最轻的一种异常
* trap 陷阱 常通常用在调试中
* abort 终止 严重的异常类型
  
![](20211119185242.jpg)

* 异常和不可屏蔽中断的中断向量号是由 CPU 自动提供的
* 外部设备的可屏蔽中断号是由中断代理提供的（咱们这里的中断代理是 8259A） 
* 软中断是由软件提供

# 中断描述符（IDT）
保护模式下用于存储中断处理程序入口的表， 保护模式下用于存储中断处理程序入口的表，当CPU 接收一个中断时，需要用中断向量在此表中检索对应的描述符，在该描述符中找到中断处理程序的起始地址，然后执行中断处理程序。