---
title: 真象还原-中断
date: 2021-11-19 10:14:40
tags:
categories:
- 操作系统
---
<!-- TODO: 没有学好 -->
由于 CPU 获知了计算机中发生的某些事，CPU 暂停正在执行的程序，转而去执行处理该事件的程序， 当这段程序执行完毕后，CPU 继续执行刚才的程序。整个过程称为中断处理，也称为中断。

操作系统是中断驱动的。操作系统是个死循环，保证操作系统能保证操作系统周而复始的运行下去，而运行的目的是为了等候某些事情发生

我们在汇编的时候学过中断。是实模式下的中断。我们即将要学的是在保护模式下的中断。 实模式下用于存储中断处理程序入口的表叫中断向量表。 而保护模式下，中断的的入口程序是中断描述符

# 中断的分类
* 来自 CPU 外部的中断就称为外部中断（是否导致宕机来划分）
    * 可屏蔽中断 
    * 不可屏蔽中断
* 来自 CPU 内部的中断称为内部中断（否正常来划分）
  * 软中断
  * 异常

外部硬件的中断是通过两根信号线通知 CPU 的， 这两根信号线就是INTR和 NMI,我们在汇编的时候了解过。
![](20211119180823.jpg)

所有的外部设备的中断信息都走一根信号线。

* 只要从 INTR 引脚收到的中断都是不影响系统运行的，可以随时处理，甚至 CPU 可以不处理，它不影响 CPU 运行。
* 只要从 NMI 引脚收到的中断，会影响cpu运行。


中断机制的本质是来了一个中断信号后，调用相应的中断处理程序。所以，CPU 不管有多少种类型的中断，为了统一中断管理，把来自外部设备、内部指令的各种中断类型统统归结为一种管理方式，即为每个中断信号分配一个整数，用此整数作为中断的 ID，而这个整数就是所谓的中断向量，然后用此 ID 作为中断描述符表中的索引，这样就能找到对应的表项，进而从中找到对应的中断处理程序。
## 可屏蔽中断
可屏蔽的意思是此外部设备发出的中断，CPU 可以不理会，因为它不会让系统宕机，所以可以通过 eflags 寄存器的 IF 位将所有这些外部设备的中断屏蔽。

Linux把中断分为上半部和下半部分开处理。

操作系统是中断驱动的，中断发生后会执行相应的中断处理程序，中断处理程序中需要立即执行的部分在上半部，完成中断应答或硬件复位等重要紧迫工作。中断处理程序中不紧急的部分则被推迟到下半部中去完成。上半部是在关中断的情况下执行，不可被打扰，下半部则不是。

中断发起时，相应的中断向量号通过 NMI 或 INTR 引脚被传入 CPU，中断向量号是中断向量表或中断描述符表里中断项的下标，CPU 根据此中断向量号在中断向量表或中断描述符表中检索对应的中断处理程序并去执行。

## 不可屏蔽中断
不可屏蔽中断是通过 NMI 引脚进入 CPU 的，它表示系统中发生了致命的错误，它等同于宣布：计算机的运行到此结束了。

# 内部中断
软中断，就是由软件主动发起的中断，因为它来自于软件，所以称之为软中断。由于该中断是软件运行中主动发起的，所以它是主观上的，并不是客观上的某种内部错误。

中断的指令
* `int 8位立即数` : 系统调用
* `int3`: 调试断点指令
* `into`: 中断溢出指令
* `bound`: 这是检查数组索引越界指令

除第一种的 “int 8位立即数” 之外， 其他的几种又可以称为异常。ˢ因为它们既具备软中断的“主动”行为，又具备异常的“错误”结果。

异常分为三种：
* fault 故障 可以被修复，属于最轻的一种异常
* trap  陷阱 常通常用在调试中
* abort 终止 严重的异常类型
  
![](https://isam2016hexo.oss-cn-hangzhou.aliyuncs.com/img/20211119185242.jpg)

* 异常和不可屏蔽中断的中断向量号是由 CPU 自动提供的
* 外部设备的可屏蔽中断号是由中断代理提供的（咱们这里的中断代理是 8259A） 
* 软中断是由软件提供

# 中断描述符（IDT）
保护模式下用于存储中断处理程序入口的表， 保护模式下用于存储中断处理程序入口的表，当CPU 接收一个中断时，需要用中断向量在此表中检索对应的描述符，在该描述符中找到中断处理程序的起始地址，然后执行中断处理程序。

中断描述符*表*中包含中断描述，任务门描述符和陷阱门描述符。由于表中所有描述符都是记录一段程序的起始地址，相当于通向某段程序的“大门” ，所以，中断描述符表中的描述符有自己的名称—门。

门，用门来表示一段程序的入口。段描述符中描述的是一片内存区域，而门描述符中描述的是一段代码。

所有的描述符都是8个字节64位。type 字段是用来描述一个描述符的类型。s位永安里表示系统段或者非系统段（数据段）。


## 任务门
* 任务门和任务状态段 TSS 是 Intel 硬件级提供的任务切换机制，所以需要任务门配合 TSS 使用。
* 任务门可以位于 GDT、LDT、IDT 中。
* type值为0101。
* 任务门大多数操作系统都没使用。
![]() 

## 中断门
* 中断门包含了中断处理程序所在段的段选择子和段内偏移地址（中断处理程序的地址）。当通过此方式进入中断后，标志寄存器 eflags 的 IF 位自动置零。
* 中断门可以位于 IDT 中。
* type值为1110。

![]() 


## 陷阱门
* 陷阱门和中断门非常相似，区别是由陷阱门进入中断后，标志寄存器eflags中的IF位不会自动置0。
* 陷阱门可以位于 IDT 中。
* type值1111。


## 调用门
* 调用门是提供给用户进程进入特权0级的方式，其DPL为3。
* 调用门可以位于 GDT 和 LDT 中。
* type值 1100。

现代操作系统为了简化开发、提升性能和移植性等原因，很少用到调用门和任务门。

<!-- TODO: 中断向量表内存图 -->

低端 1MB 内存布局中，中断向量表位于地址 0～0x3ff，它是实模式下用于存储中断处理程序入口的表。它的位置是固定的，必须位于最低端。

对比中断向量表，中断描述符表有两个区别
* （1）中断描述符表地址不限制，在哪里都可以
* （2）中断描述符表中的每个描述符用 8 字节描述
  
中断描述符的位置在中断描述符寄存器（IDTR） 和GDRT 原理一样。中断描述符表地址肯定要加载到这个寄存器中。

中断描述符符表寄存器ID
![]( ) 

加载指令：`lidt 48位内存数据`

# 中断处理过程及保护

完整的中断过程分为 CPU 外和 CPU 内两部分。

* CPU 外：外部设备的中断由中断代理芯片接收，处理后将该中断的中断向量号发送到 CPU。 Φ
* CPU 内：CPU 执行该中断向量号对应的中断处理程序。

CPU 内的过程: 
1. 处理器根据中断向量号定位中断门描述符。
2. 处理器进行特权级检查
  1. 对于软件发起的软中断，当前特权级 CPL 必须位于 门描述符 DPL 和门中目标代码段描述符 DPL 之间（特权比门高，才能使用门，特权比处理程序低，才能使用门调用处理程序，特权转移只能从低到高进行）。
  2. 对于外部设备引起的中断和异常，则只检查 CPL 和目标代码段 DPL ，CPL 权限要小于 DPL 才行
3. 执行中断处理程序

特权级检查通过后，将门描述符目标代码段选择子加载到代码段寄存器 CS 中，把门描述符中中断处理程序的偏移地址加载到 EIP，开始执行中断处理程序。

中断发生后，eflags 中的 NT 位和 TF 位会被置零，如果是中断门，则 IF 位也置零

从中断返回的指令是 iret，从栈中弹出数据到寄存器 cs、eip、eflags 等，根据特权级是否改变决定是否要恢复旧栈

