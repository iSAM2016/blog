---
title: 缓存
date: 2022-02-01 13:35:56
tags:
categories:
---


# 缓存

##  相关概念

>[浏览器的协商缓存与强缓存](http://caibaojian.com/browser-cache.html)

###  缓存作用
    
    缓存减少了冗余数据传输，缓解了网络瓶颈问题，降低了对原始服务器的要求，降低了延时距离，如何衡量其有效性及将缓存置于何处可以发挥最大的作用。还用缓存检查新鲜度的问题

### 缓存命中
    
    可以使用已有的副本为某些达到缓存的请求提供服务，这被称为缓存命中。其他一些达到花村的请求可能会由于没有副本可用，而被转发给原始服务器。被称为缓存未命中。

### 新鲜度检查

    原始服务器的内容可能会法伤变化，缓存要对其进行检测，看看他们保存的副本是否是服务器上最新的副本。

### 再验证命中或缓慢命中
  
    缓存对缓存的副本进行再验证时候，会向服务器发送一个小的再请求验证，如果内容没有变化，服务器会以一个小的304（NOT Modified）进行响应。只要缓存知道副本任然有效，就会再次将副本标记为暂时新鲜的，并将副本提供给客户端.Http提供了几个工具，用的最多的是if-Modified-Since。在请求中添加该字段，告诉服务器只有在缓存了对象的副本之后，又对其进行的修改情况下才发送对象

### 缓存的拓扑结构：

* 私有缓存：一般是我们的浏览器
* 公有缓存：（代理缓存,不做讨论）

### 缓存的处理步骤

1. 接收- 缓存从网络中读取抵达的请求报文

2. 解析- 缓存对报文进行解析，提取出url和各种首部

3. 查询- 缓存查看是否有本地副本可用，如果没有，就获取一份副本（并将其保存在本地）

4. 新鲜度检测- 缓存查看已缓存副本是否足够新鲜，如果不是，就询问服务器是否有任何的更新

5. 创建响应- 缓存回会用新的首部和已缓存的主体来共偶见一天响应报文

6. 发送

7. 日志

![处理一个新鲜的缓存命中](../../img/cache.jpg)

![处理一个新鲜的缓存命中](../../img/progress.jpeg)


## 3.2 缓存详细介绍

现在看来，缓存部分有些疑惑，条理不清楚，请仔细阅读HTT缓存控制小结

* [通过express框架简单实践几种设置HTTP对缓存的控制](https://www.jianshu.com/p/3bc803a4313f)

* [HTTP缓存控制小结](http://imweb.io/topic/5795dcb6fb312541492eda8c)

* [《图解HTTP》笔记——HTTP首部(通用请求与客户端请求)](http://blog.csdn.net/qq_34289537/article/details/52971516)

* [http状态码301和302详解及区别——辛酸的探索之路](http://blog.csdn.net/grandPang/article/details/47448395)

* [HTTP 首部字段详细介绍](http://www.cnblogs.com/jycboy/p/http_head.html)

![](../../img/caches.png)

**说明：**

    Expiresf相比，Cache-control 更加，精准控制缓存，并且有更高的优先级

    浏览器在Cache-control 指定no-cache或者max-age和Expires均过期之后，将Etag值通过If-none-match作为请求首部发送给服务器，服务器接受到请求之后，对比所请求资源的Etag值是否改变，如果未改变则返回304 Not Modified, 并且根据既定的缓存策略分配新的Cache-control 信息； ...

    如果强制浏览器使用协商缓存策略，需要将Cache-control 首部信息设置为no-cache,这样不会判断max-age 和 Expires 过期时间，从而每次资源请求都会经过服务器对比。

**补充**

web缓存的种类

* 1 数据库缓存

　　我们可能听说过memcached，它就是一种数据库层面的缓存方案。数据库缓存是指，当web应用的关系比较复杂，数据库中的表很多的时候，如果频繁进行数据库查询，很容易导致数据库不堪重荷。为了提供查询的性能，将查询后的数据放到内存中进行缓存，下次查询时，直接从内存缓存直接返回，提供响应效率。

* 2 CDN缓存

　　CDN缓存一般是由网站管理员自己部署，为了让他们的网站更容易扩展并获得更好的性能。通常情况下，浏览器先向CDN网关发起Web请求，网关服务器后面对应着一台或多台负载均衡源服务器，会根据它们的负载请求，动态将请求转发到合适的源服务器上。从浏览器角度来看，整个CDN就是一个源服务器，从这个层面来说，浏览器和服务器之间的缓存机制，在这种架构下同样适用。

* 3 代理服务器缓存

　　代理服务器是浏览器和源服务器之间的中间服务器，浏览器先向这个中间服务器发起Web请求，经过处理后（比如权限验证，缓存匹配等），再将请求转发到源服务器。代理服务器缓存的运作原理跟浏览器的运作原理差不多，只是规模更大。

* 4 浏览器缓存

　　每个浏览器都实现了 HTTP 缓存，我们通过浏览器使用HTTP协议与服务器交互的时候，浏览器就会根据一套与服务器约定的规则进行缓存工作。

* 5 应用层缓存

　　应用层缓存是指我们在代码层面上做的缓存。通过代码逻辑，把曾经请求过的数据或资源等，缓存起来，再次需要数据时通过逻辑上的处理选择可用的缓存的数据。

# 4 缓存的策略解释(重点)

* [浏览器的协商缓存与强缓存](http://caibaojian.com/browser-cache.html)
* [cache 细节，缓存整体流程和细节](https://juejin.im/entry/58579599b123db00658292a0)

在阅读相关的文章的时候，我们看到缓存策略是个倒三角，对应的作用是不同的。从上到下可以概括为：

* 缓存存储策略
* 缓存过期策略
* 缓存对比策略


* 缓存存储策略

这个策略的作用只有一个，用于决定 Http 响应内容是否可缓存到客户端

对于 Cache-Control 头里的 Public、Private、no-cache、max-age 、no-store 他们都是用来指明响应内容是否可以被客户端存储的，其中前4个都会缓存文件数据（关于 no-cache 应理解为“不建议使用本地缓存”，其仍然会缓存数据到本地），后者 no-store 则不会在客户端缓存任何响应数据

通过 Cache-Control：Public 设置我们可以将 Http 响应数据存储到本地，但此时并不意味着后续浏览器会直接从缓存中读取数据并使用，为啥？因为它无法确定本地缓存的数据是否可用（可能已经失效），还必须借助一套鉴别机制来确认才行， 这就是我们下面要讲到的“缓存过期策略”。

* 缓存过期策略

这个策略的作用也只有一个，那就是决定客户端是否可直接从本地缓存数据中加载数据并展示（否则就发请求到服务端获取）

刚上面我们已经阐述了数据缓存到了本地后还需要经过判断才能使用，那么浏览器通过什么条件来判断呢？ 答案是：Expires，Expires 指名了缓存数据有效的绝对时间，告诉客户端到了这个时间点（比照客户端时间点）后本地缓存就作废了，在这个时间点内客户端可以认为缓存数据有效，可直接从缓存中加载展示。

不过 Http 缓存头设计并没有想象的那么规矩，像上面提到的 Cache-Control（这个头是在Http1.1里加进来的）头里的 no-cache 和 max-age 就是特例，它们既包含缓存存储策略也包含缓存过期策略，以 max-age 为例，他实际上相当于：

Cache-Control：public/private（这里不太确定具体哪个）
Expires：当前客户端时间 + maxAge 。
而 Cache-Control：no-cache 和 Cache-Control：max-age=0 （单位是秒）相当


